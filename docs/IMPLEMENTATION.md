# AI交易神谕终端系统实现

本文档详细记录AI交易神谕终端系统的技术实现方式，包括各个组件、流程和数据交互。

## 系统架构

AI交易神谕终端采用以下技术架构：

- **前端**：Vue.js + Vite构建的轻量级界面
- **后端**：Node.js + Express + MongoDB构建的RESTful API
- **自动化工作流**：n8n作为核心工作流引擎
- **交易执行**：通过3Commas API进行策略执行
- **数据源**：CoinGlass API提供市场数据
- **AI分析**：MMXM Agent进行交易方向判断，可选Perplexity Sonar提供深度研究

## 详细实现流程

### 1. 后端API系统

1. **技术栈**
   - Node.js + Express构建RESTful API
   - TypeScript提供类型安全
   - MongoDB作为数据存储
   - JWT实现认证机制

2. **核心模块**
   - **用户模块**：用户管理、身份验证、钱包连接
   - **交易模块**：交易订单管理、跟单系统、交易对管理
   - **神谕模块**：神谕预测、历史记录、统计分析
   - **EAT代币模块**：代币余额、交易记录、奖励系统
   
3. **数据模型**
   - **用户(User)**：账户信息、钱包地址、EAT余额、推荐关系
   - **交易(Trade)**：交易订单、跟单列表、执行状态
   - **神谕(Oracle)**：预测内容、信心指数、时效性、分析数据
   - **EAT交易(EatTransaction)**：代币流转记录、交易类型、状态

4. **API路由架构**
   - `/api/auth`：注册、登录、刷新令牌
   - `/api/users`：用户管理、钱包连接
   - `/api/trades`：交易订单、跟单操作
   - `/api/oracles`：神谕预测、历史记录
   - `/api/eat`：EAT余额、转账、领取奖励

5. **安全机制**
   - JWT令牌认证
   - 角色权限控制
   - 敏感操作验证
   - 事务处理保证数据一致性

### 2. 前期准备

1. **API凭证配置**
   - 在n8n凭据管理中配置CoinGlass与3Commas API密钥
   - 权限级别：需要3Commas读写权限，CoinGlass只需读取权限

2. **交易机器人配置**
   - 在3Commas后台创建两个DCA机器人：
     - Long Bot：专门执行做多DCA策略
     - Short Bot：专门执行做空DCA策略
   - 机器人配置参数：
     - 同时活跃仓位：1
     - 配置触发条件、分批加仓、止盈止损等内部参数

3. **Webhook设置**
   - 在n8n中新建Webhook节点
   - 功能：接收外部一次性提交的需监控交易对列表
   - 数据格式：JSON数组，包含交易对符号(如["BTC/USDT", "ETH/USDT"])

### 3. 周期性行情收集（4小时）

1. **数据获取实现**
   - 使用n8n的HTTP Request节点调用CoinGlass API
   - 获取数据：4小时K线、资金费率、未平仓合约(OI)、Order-book Heatmap
   - 轮询间隔：每4小时执行一次

2. **AI分析处理**
   - 数据预处理：将原始数据格式化为MMXM Agent要求的输入格式
   - 调用MMXM Agent API，获取：
     - 交易方向（多/空）
     - 关键价格区间
     - 建议止盈价格
     - 建议止损价格
   
3. **结果存储**
   - 将AI判断结果存储在n8n内存变量中
   - 数据结构：`{symbol: {direction, entryZone, takeProfit, stopLoss, timestamp}}`
   
4. **深度研究（可选）**
   - 调用Perplexity Sonar API进行深度市场研究
   - 保存文字解读结果供通知使用

### 4. 实时价格监听

1. **价格数据获取**
   - 主要方式：通过CoinGlass WebSocket实时获取价格数据
   - 备选方式：使用1分钟轮询HTTP请求（防止WebSocket断线）
   
2. **判断逻辑实现**
   - 每次收到新价格时，读取步骤2中存储的MMXM判断结果
   - 条件判断：
     - 做多条件：方向为"做多"且价格位于"止损价 < 现价 < 止盈价"
     - 做空条件：方向为"做空"且价格位于"止盈价 < 现价 < 止损价"
   
3. **WebSocket实现细节**
   - 使用n8n的WebSocket节点建立连接
   - 断线重连策略：检测到断线后5秒内自动重连，最多尝试5次
   - 数据格式解析：JSON解析获取最新价格

### 5. 策略开关实现

1. **机器人控制**
   - 通过3Commas API执行机器人开关控制
   - 实现方式：使用n8n的HTTP Request节点发送POST请求
   
2. **开关逻辑**
   - 当满足启动条件时：
     - 开启对应方向的DCA机器人（Long或Short）
     - 关闭另一方向的机器人
   - API操作：`POST /ver1/bots/{bot_id}/enable` 和 `POST /ver1/bots/{bot_id}/disable`
   
3. **边界条件处理**
   - 价格超出区间判断：
     - 监控价格是否超出MMXM给定的区间
     - 超出时自动关闭已开启的机器人
   - 等待下一轮4小时更新后再决定是否重新开启

### 6. 监控与通知

1. **通知系统实现**
   - 使用n8n的Slack/Telegram节点发送通知
   - 触发条件：机器人被打开或关闭时
   
2. **通知内容**
   - 交易对和方向
   - 价格区间信息
   - 开关动作说明
   - 触发价格
   - Heatmap关键信息
   - Sonar分析摘要（如有）
   
3. **错误处理**
   - API超时或限频处理：
     - 自动重试策略：3次重试，间隔递增（5秒、10秒、20秒）
     - 最终失败时发送告警消息

### 7. 后端与n8n工作流集成

1. **集成方式**
   - 后端通过HTTP请求调用n8n的Webhook触发工作流
   - n8n处理完成后通过回调API将结果返回给后端系统

2. **数据流向**
   - 后端系统将交易对、时间框架等参数传递给n8n
   - n8n执行分析流程，调用多个智能体进行分析
   - 分析结果返回给后端，存储为新的神谕预测

3. **错误处理**
   - 超时重试机制
   - 失败通知和日志记录
   - 备用分析模式（当智能体系统不可用时）

### 8. 可选拓展实现

1. **历史复盘**
   - 在n8n流程中添加CSV/Google Sheets写入节点
   - 记录内容：机器人开关时间、关仓时间、价格水平、盈亏结果
   
2. **多时间框架**
   - 复制现有流程并调整为不同时间粒度
   - 建立独立的短周期机器人控制逻辑
   
3. **可视化实现**
   - 数据同步：将交易数据导出至外部系统
   - 支持平台：Grafana Cloud或Google Data Studio
   - 更新频率：每小时或实时推送

## 技术依赖

| 组件名称 | 版本/要求 | 用途 |
|---------|----------|------|
| Node.js | 18.x+ | 后端运行环境 |
| Express | 4.18.x | Web框架 |
| MongoDB | 7.x+ | 数据库 |
| TypeScript | 5.x | 类型安全 |
| JWT | 9.x | 认证机制 |
| n8n | 最新版 | 工作流自动化引擎 |
| CoinGlass API | - | 加密货币市场数据源 |
| 3Commas API | - | 交易机器人控制 |
| MMXM Agent | - | AI交易方向判断 |
| Perplexity Sonar | - | 深度市场研究（可选） |
| Vue.js | latest | 前端框架 |
| Vite | latest | 前端构建工具 |

## 待办事项

- 实现n8n工作流与后端的集成接口
- 创建测试数据生成脚本
- 编写完整的API文档
- 确定Heatmap中"大单密集"阈值与描述口径
- 为MMXM Agent制作可供n8n调用的服务镜像
- 预设Perplexity Sonar配额耗尽时的GPT-4o备用方案
- 定义WebSocket断线后的自动重连策略详细实现 