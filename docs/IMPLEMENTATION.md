# AI交易神谕终端系统实现

本文档详细记录AI交易神谕终端系统的技术实现方式，包括各个组件、流程和数据交互。

## 系统架构

AI交易神谕终端采用以下技术架构：

- **前端**：Vue.js + Vite构建的轻量级界面
- **自动化工作流**：n8n作为核心工作流引擎
- **交易执行**：通过3Commas API进行策略执行
- **数据源**：CoinGlass API提供市场数据
- **AI分析**：MMXM Agent进行交易方向判断，可选Perplexity Sonar提供深度研究

## 详细实现流程

### 1. 前期准备

1. **API凭证配置**
   - 在n8n凭据管理中配置CoinGlass与3Commas API密钥
   - 权限级别：需要3Commas读写权限，CoinGlass只需读取权限

2. **交易机器人配置**
   - 在3Commas后台创建两个DCA机器人：
     - Long Bot：专门执行做多DCA策略
     - Short Bot：专门执行做空DCA策略
   - 机器人配置参数：
     - 同时活跃仓位：1
     - 配置触发条件、分批加仓、止盈止损等内部参数

3. **Webhook设置**
   - 在n8n中新建Webhook节点
   - 功能：接收外部一次性提交的需监控交易对列表
   - 数据格式：JSON数组，包含交易对符号(如["BTC/USDT", "ETH/USDT"])

### 2. 周期性行情收集（4小时）

1. **数据获取实现**
   - 使用n8n的HTTP Request节点调用CoinGlass API
   - 获取数据：4小时K线、资金费率、未平仓合约(OI)、Order-book Heatmap
   - 轮询间隔：每4小时执行一次

2. **AI分析处理**
   - 数据预处理：将原始数据格式化为MMXM Agent要求的输入格式
   - 调用MMXM Agent API，获取：
     - 交易方向（多/空）
     - 关键价格区间
     - 建议止盈价格
     - 建议止损价格
   
3. **结果存储**
   - 将AI判断结果存储在n8n内存变量中
   - 数据结构：`{symbol: {direction, entryZone, takeProfit, stopLoss, timestamp}}`
   
4. **深度研究（可选）**
   - 调用Perplexity Sonar API进行深度市场研究
   - 保存文字解读结果供通知使用

### 3. 实时价格监听

1. **价格数据获取**
   - 主要方式：通过CoinGlass WebSocket实时获取价格数据
   - 备选方式：使用1分钟轮询HTTP请求（防止WebSocket断线）
   
2. **判断逻辑实现**
   - 每次收到新价格时，读取步骤2中存储的MMXM判断结果
   - 条件判断：
     - 做多条件：方向为"做多"且价格位于"止损价 < 现价 < 止盈价"
     - 做空条件：方向为"做空"且价格位于"止盈价 < 现价 < 止损价"
   
3. **WebSocket实现细节**
   - 使用n8n的WebSocket节点建立连接
   - 断线重连策略：检测到断线后5秒内自动重连，最多尝试5次
   - 数据格式解析：JSON解析获取最新价格

### 4. 策略开关实现

1. **机器人控制**
   - 通过3Commas API执行机器人开关控制
   - 实现方式：使用n8n的HTTP Request节点发送POST请求
   
2. **开关逻辑**
   - 当满足启动条件时：
     - 开启对应方向的DCA机器人（Long或Short）
     - 关闭另一方向的机器人
   - API操作：`POST /ver1/bots/{bot_id}/enable` 和 `POST /ver1/bots/{bot_id}/disable`
   
3. **边界条件处理**
   - 价格超出区间判断：
     - 监控价格是否超出MMXM给定的区间
     - 超出时自动关闭已开启的机器人
   - 等待下一轮4小时更新后再决定是否重新开启

### 5. 监控与通知

1. **通知系统实现**
   - 使用n8n的Slack/Telegram节点发送通知
   - 触发条件：机器人被打开或关闭时
   
2. **通知内容**
   - 交易对和方向
   - 价格区间信息
   - 开关动作说明
   - 触发价格
   - Heatmap关键信息
   - Sonar分析摘要（如有）
   
3. **错误处理**
   - API超时或限频处理：
     - 自动重试策略：3次重试，间隔递增（5秒、10秒、20秒）
     - 最终失败时发送告警消息

### 6. 可选拓展实现

1. **历史复盘**
   - 在n8n流程中添加CSV/Google Sheets写入节点
   - 记录内容：机器人开关时间、关仓时间、价格水平、盈亏结果
   
2. **多时间框架**
   - 复制现有流程并调整为不同时间粒度
   - 建立独立的短周期机器人控制逻辑
   
3. **可视化实现**
   - 数据同步：将交易数据导出至外部系统
   - 支持平台：Grafana Cloud或Google Data Studio
   - 更新频率：每小时或实时推送

## 技术依赖

| 组件名称 | 版本/要求 | 用途 |
|---------|----------|------|
| n8n | 最新版 | 工作流自动化引擎 |
| CoinGlass API | - | 加密货币市场数据源 |
| 3Commas API | - | 交易机器人控制 |
| MMXM Agent | - | AI交易方向判断 |
| Perplexity Sonar | - | 深度市场研究（可选） |
| Vue.js | latest | 前端框架 |
| Vite | latest | 前端构建工具 |

## 待办事项

- 确定Heatmap中"大单密集"阈值与描述口径
- 为MMXM Agent制作可供n8n调用的服务镜像
- 预设Perplexity Sonar配额耗尽时的GPT-4o备用方案
- 定义WebSocket断线后的自动重连策略详细实现 